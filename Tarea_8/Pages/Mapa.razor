@page "/Mapa"
@using Tarea_8.Models
@using BlazorLeaflet
@using BlazorLeaflet.Models
@using BlazorLeaflet.Models.Events
@using Tarea_8.Shared
@inject IJSRuntime jsr


<br>
<h4>Mapa</h4>
<div id="mapContainer" style="width: 700px; height: 300px;">
   <LeafletMap Map="_map" />
</div>

<br>
<h4 align = "center">Pacientes</h4>
<table class="table">
  <thead>
    <tr>
      <th>Cedula</th>
      <th>Nombre</th>
      <th>Vacuna 1</th>
      <th>Vacuna 2</th>
    </tr>
  </thead>
  <tbody>
    @foreach (Pacientes paciente in pacientes)
    {
      <tr>
        <td>@paciente.cedula</td>
        <td>@paciente.Nombre</td>
        <td>@paciente.FechaPrimeraVacuna</td>
        <td>@paciente.FechaSegundaVacuna</td>
      </tr>
    }
  </tbody>
</table>


@code{
    private Map _map = null;
    private Pacientes paciente = null;
    private List<Pacientes> pacientes = null;



 protected override void OnInitialized() {
     vacunadosrdv2Context bd = new vacunadosrdv2Context();

     pacientes = bd.Pacientes.ToList();
     _map = new Map(jsr){
            Center = new LatLng(18.9f, -70f),
            Zoom = 7.47f
        };

         _map.OnInitialized += () => {
            _map.AddLayer(new TileLayer {                
                UrlTemplate = "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
                Attribution = "&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors",
            });
             foreach(var p in pacientes){
            

                var marker = new Marker(p.Latitud, p.Longitud) {
                    Title = p.Id.ToString(),
                    RiseOnHover = true,
                    Tooltip = new Tooltip() {
                        Content = $"{p.cedula}",
                        IsPermanent = false
                    }
                };

                marker.OnClick += (InteractiveLayer sender, MouseEvent e) => {
                    var marker = (Marker) sender;

                    paciente = bd.Pacientes.First(x => x.Id == Convert.ToInt32(marker.Title));

                    StateHasChanged();
                };

                _map.AddLayer(marker);
            }
         };

       
        

         }

}